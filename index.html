<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>💈 Asistente Virtual — Peluquería Sialweb</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#000; --text:#fff; --muted:#d6d6d6; --gold:#d4af37; --gold-2:#b9931a;
      --card:#0f0f0f; --bubble:#1a1a1a; --bubble-user:#1e2a39; --ring:rgba(212,175,55,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0;background:var(--bg);color:var(--text);font-family:"Cormorant Garamond", ui-serif, Georgia, "Times New Roman", serif;display:flex;align-items:center;justify-content:center;padding:24px; }
    #chat-wrap{ width:min(780px, 92vw);background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 10px 28px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.06) inset;overflow:hidden; }
    #chat-head{ padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));font-weight:600; letter-spacing:.2px;color:var(--gold); }
    #chat{ height:min(60vh, 560px);min-height:360px; padding:16px; overflow-y:auto; scroll-behavior:smooth; }
    .msg{margin:10px 0; padding:10px 14px; border-radius:18px; max-width:85%; line-height:1.45; border:1px solid transparent; white-space: pre-wrap;}
    .bot{background:var(--bubble); color:var(--text); float:left; clear:both; border-color:rgba(255,255,255,.08); box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .user{background:var(--bubble-user); color:var(--text); float:right; clear:both; border-color:rgba(15,76,129,.25); box-shadow:0 6px 18px rgba(0,0,0,.35)}
    #input-area{display:flex; gap:10px; padding:12px; border-top:1px solid rgba(255,255,255,.08); background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01))}
    #inputTexto{flex:1; padding:12px 14px; font-size:16px; color:var(--text); background:#0e0e0e; border:1px solid rgba(255,255,255,.14); border-radius:18px; outline:none; transition:box-shadow .15s, border-color .15s}
    #inputTexto:focus{ border-color:var(--gold); box-shadow:0 0 0 3px var(--ring)}
    button{ padding:12px 18px; font-size:16px; font-weight:600; color:#151515; background:linear-gradient(180deg, var(--gold), var(--gold)); border:1px solid var(--gold); border-radius:18px; cursor:pointer; transition:transform .15s, box-shadow .15s, background .15s, border-color .15s; }
    button:hover{ transform:translateY(-1px); background:linear-gradient(180deg, var(--gold-2), var(--gold-2)); border-color:var(--gold-2); box-shadow:0 8px 22px rgba(212,175,55,.25); }
    button:active{ transform:translateY(0); box-shadow:none; }
    .component-container { float: left; clear: both; width: 100%; margin: 10px 0; }
    .day-selector, .hour-selector, .choice-selector { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 0; }
    .day-button, .hour-button, .choice-button { background: #2a2a2a; border: 1px solid #444; color: #fff; padding: 8px 12px; border-radius: 12px; cursor: pointer; font-family: inherit; font-size: 15px; }
    .day-button:hover, .hour-button:hover, .choice-button:hover { background: var(--gold); color: #000; }
  </style>
</head>
<body>
  <div id="chat-wrap">
    <div id="chat-head">💈 Asistente Virtual — Peluquería Sialweb</div>
    <div id="chat"></div>
    <div id="input-area">
      <input id="inputTexto" type="text" placeholder="Escribe un mensaje..." autocomplete="off" />
      <button id="btnEnviar">Enviar</button>
    </div>
  </div>

  <script>
    const API_URL = "http://127.0.0.1:5001/mensaje";
    const chat = document.getElementById("chat");
    const input = document.getElementById("inputTexto");
    const btnEnviar = document.getElementById("btnEnviar");

    function agregarMensaje(texto, tipo) {
      const div = document.createElement("div");
      div.className = `msg ${tipo}`;
      div.textContent = texto;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // --- FUNCIÓN DE DIBUJO DE COMPONENTES MEJORADA ---
    function dibujarComponente(componente) {
        const container = document.createElement("div");
        container.className = "component-container";
        
        let selectorDiv;
        if (componente.type === 'day_selector') {
            selectorDiv = document.createElement("div"); selectorDiv.className = "day-selector";
            componente.days.forEach(item => {
                const button = document.createElement("button"); button.className = "day-button";
                button.textContent = item.display;
                button.addEventListener("click", () => enviarMensaje(item.value));
                selectorDiv.appendChild(button);
            });
        } else if (componente.type === 'hour_selector') {
            selectorDiv = document.createElement("div"); selectorDiv.className = "hour-selector";
            componente.hours.forEach(item => {
                const button = document.createElement("button"); button.className = "hour-button";
                button.textContent = item;
                button.addEventListener("click", () => enviarMensaje(item));
                selectorDiv.appendChild(button);
            });
        } else if (componente.type === 'choice_buttons') { // <-- Nuevo tipo de componente
            selectorDiv = document.createElement("div"); selectorDiv.className = "choice-selector";
            componente.choices.forEach(item => {
                const button = document.createElement("button"); button.className = "choice-button";
                button.textContent = item;
                button.addEventListener("click", () => enviarMensaje(item));
                selectorDiv.appendChild(button);
            });
        }

        if (selectorDiv) {
            container.appendChild(selectorDiv);
            chat.appendChild(container);
            chat.scrollTop = chat.scrollHeight;
        }
    }

    async function enviarMensaje(textoUsuario) {
      // Ocultamos la barra de texto mientras el bot responde para evitar envíos múltiples
      document.getElementById('input-area').style.display = 'none';

      if (textoUsuario) {
        agregarMensaje(textoUsuario, "user");
      }
      
      try {
        const respuesta = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ mensaje: textoUsuario })
        });
        if (!respuesta.ok) throw new Error(`Error del servidor: ${respuesta.status}`);
        const datos = await respuesta.json();
        
        if (datos && datos.respuesta) {
          agregarMensaje(datos.respuesta, "bot");
        }
        if (datos && datos.ui_component) {
          dibujarComponente(datos.ui_component);
        }
      } catch (error) {
        agregarMensaje("❌ Error de conexión.", "bot");
      } finally {
        // Volvemos a mostrar la barra de texto al final, pase lo que pase
        document.getElementById('input-area').style.display = 'flex';
        input.focus();
      }
    }
    
    function manejarEnvio() {
        const texto = input.value.trim();
        // Permitimos el envío de texto vacío solo si NO hay botones en pantalla
        const hayBotones = chat.querySelector('button');
        if (texto || !hayBotones) {
            enviarMensaje(texto);
            input.value = "";
            input.focus();
        }
    }

    btnEnviar.addEventListener("click", manejarEnvio);
    input.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        manejarEnvio();
      }
    });

    window.addEventListener("DOMContentLoaded", () => enviarMensaje(""));
  </script>
</body>
</html>